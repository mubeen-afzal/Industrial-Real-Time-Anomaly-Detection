<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Scheer | Industrial Digital Twin</title>
    
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #0e1117; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        .card { background-color: #1e1e1e; border: 1px solid #333; border-radius: 8px; padding: 1.5rem; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: bold; font-size: 0.875rem; }
        .status-normal { background-color: #198754; color: white; }
        .status-critical { background-color: #dc3545; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .table-container { max-height: 300px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: #2d2d2d; padding: 12px; text-align: left; position: sticky; top: 0; }
        td { padding: 10px; border-bottom: 1px solid #333; font-family: monospace; }
        tr:first-child { background-color: #2c3e50; font-weight: bold; border-left: 4px solid #3498db; }
    </style>
</head>
<body class="min-h-screen p-6">

    <!-- Header -->
    <header class="mb-8 flex justify-between items-center border-b border-gray-700 pb-4">
        <div>
            <h1 class="text-3xl font-bold text-blue-400">üè≠ Pump Station 4: Digital Twin</h1>
            <p class="text-gray-400 mt-1">Real-time Predictive Maintenance Dashboard (Connected to SQLite DB)</p>
        </div>
        <div class="flex gap-4">
            <button onclick="startSimulation()" id="startBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded transition">
                ‚ñ∂ Start Simulation
            </button>
            <div id="apiStatus" class="flex items-center gap-2 text-sm text-gray-500">
                <span class="w-3 h-3 rounded-full bg-gray-500" id="apiDot"></span>
                Disconnected
            </div>
        </div>
    </header>

    <!-- KPI Grid -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="card">
            <h3 class="text-gray-400 text-sm font-uppercase">Machine Status</h3>
            <div class="mt-2"><span id="kpiStatus" class="status-badge bg-gray-600">Waiting...</span></div>
        </div>
        <div class="card">
            <h3 class="text-gray-400 text-sm font-uppercase">Anomaly Score (MSE)</h3>
            <div class="mt-2 text-3xl font-bold text-white" id="kpiScore">0.0000</div>
            <div class="text-xs text-gray-500 mt-1">Threshold: 0.0065</div>
        </div>
        <div class="card">
            <h3 class="text-gray-400 text-sm font-uppercase">Est. Cost Savings</h3>
            <div class="mt-2 text-3xl font-bold text-green-400" id="kpiSavings">‚Ç¨0</div>
        </div>
        <div class="card">
            <h3 class="text-gray-400 text-sm font-uppercase">AI Confidence</h3>
            <div class="mt-2 text-3xl font-bold text-blue-400" id="kpiConfidence">100%</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="card lg:col-span-2">
            <h3 class="text-lg font-semibold mb-4 text-blue-300">Historical Health Trend</h3>
            <div id="lineChart" style="height: 350px;"></div>
        </div>
        <div class="flex flex-col gap-6">
            <div class="card flex-1">
                <h3 class="text-lg font-semibold mb-2 text-blue-300">Live Health Gauge</h3>
                <div id="gaugeChart" style="height: 200px;"></div>
            </div>
            <div class="card flex-1">
                <h3 class="text-lg font-semibold mb-2 text-blue-300">Root Cause (Top Sensor)</h3>
                <div class="text-sm text-gray-300" id="rootCauseList">Waiting for data...</div>
            </div>
        </div>
    </div>

    <!-- Data Log -->
    <div class="card">
        <h3 class="text-lg font-semibold mb-4 text-blue-300">Live Sensor Telemetry Log</h3>
        <div class="table-container">
            <table class="w-full text-left">
                <thead>
                    <tr>
                        <th>Timestamp</th><th>Status</th><th>Score</th>
                        <th>Sensor_00</th><th>Sensor_01</th><th>Sensor_02</th>
                    </tr>
                </thead>
                <tbody id="logBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        const THRESHOLD = 0.0065;
        let isRunning = false;
        let accumulatedSavings = 0;
        let timeStep = 0;
        const historyX = [];
        const historyY = [];

        function initCharts() {
            Plotly.newPlot('lineChart', [{
                x: [], y: [], mode: 'lines', line: { color: '#00BFFF', width: 3 }, fill: 'tozeroy', fillcolor: 'rgba(0, 191, 255, 0.1)'
            }], {
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)', font: { color: '#e0e0e0' },
                margin: { t: 10, l: 40, r: 20, b: 40 },
                xaxis: { title: 'Time Steps', gridcolor: '#333' },
                yaxis: { title: 'MSE Loss', gridcolor: '#333', range: [0, 0.05] },
                shapes: [{ type: 'line', x0: 0, x1: 1, xref: 'paper', y0: THRESHOLD, y1: THRESHOLD, line: { color: 'red', width: 2, dash: 'dash' } }]
            });

            Plotly.newPlot('gaugeChart', [{
                type: "indicator", mode: "gauge+number", value: 0,
                gauge: {
                    axis: { range: [0, 0.05], tickcolor: "white" }, bar: { color: "#00BFFF" }, bgcolor: "#222",
                    steps: [{ range: [0, THRESHOLD], color: "rgba(25, 135, 84, 0.3)" }, { range: [THRESHOLD, 0.05], color: "rgba(220, 53, 69, 0.3)" }],
                    threshold: { line: { color: "red", width: 4 }, thickness: 0.75, value: THRESHOLD }
                }
            }], { paper_bgcolor: 'rgba(0,0,0,0)', font: { color: '#e0e0e0' }, margin: { t: 0, l: 20, r: 20, b: 0 } });
        }

        // --- NEW LOGIC: FETCH REAL DATA FROM API ---
        async function fetchRealData(status) {
            // status should be "NORMAL" or "BROKEN"
            const response = await fetch(`${API_URL}/simulate/sample?status=${status}`);
            if (!response.ok) throw new Error("Failed to fetch DB sample");
            return await response.json();
        }

        async function updateDashboard(statusTarget) {
            try {
                // 1. Get Real Data from DB
                const dataPacket = await fetchRealData(statusTarget ? "BROKEN" : "NORMAL");
                
                // 2. Send Real Data for Prediction
                const response = await fetch(`${API_URL}/predict?threshold=${THRESHOLD}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataPacket)
                });

                if (!response.ok) throw new Error("API Error");
                
                document.getElementById('apiStatus').innerHTML = `<span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span> API Connected`;
                
                const result = await response.json();
                const score = result.anomaly_score;
                const isAnomaly = result.is_anomaly;
                const sensors = dataPacket.sensor_readings;

                // KPI Updates
                const statusBadge = document.getElementById('kpiStatus');
                if (isAnomaly) {
                    statusBadge.textContent = "CRITICAL FAILURE";
                    statusBadge.className = "status-badge status-critical";
                    accumulatedSavings += 150;
                } else {
                    statusBadge.textContent = "OPERATIONAL";
                    statusBadge.className = "status-badge status-normal";
                }

                document.getElementById('kpiScore').textContent = score.toFixed(4);
                document.getElementById('kpiSavings').textContent = `‚Ç¨${accumulatedSavings.toLocaleString()}`;
                
                let confidence = 100;
                if(score < THRESHOLD) confidence = Math.min(100, (1 - (score/THRESHOLD))*100 + 20);
                else confidence = 0;
                document.getElementById('kpiConfidence').textContent = `${confidence.toFixed(1)}%`;

                // Root Cause
                const rootCauseDiv = document.getElementById('rootCauseList');
                let rcHtml = "<ul class='list-disc pl-4'>";
                for (const [sensor, err] of Object.entries(result.root_cause_analysis)) {
                    rcHtml += `<li class="mb-1"><span class="text-blue-400">${sensor}</span>: ${(err*100).toFixed(1)}% error</li>`;
                }
                rcHtml += "</ul>";
                rootCauseDiv.innerHTML = rcHtml;

                // Chart Updates
                timeStep++;
                historyX.push(timeStep);
                historyY.push(score);
                if(historyX.length > 50) { historyX.shift(); historyY.shift(); }
                Plotly.update('lineChart', { x: [historyX], y: [historyY] });
                Plotly.update('gaugeChart', { value: score });

                // Log Table
                const tbody = document.getElementById('logBody');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dataPacket.timestamp || new Date().toLocaleTimeString()}</td>
                    <td style="color: ${isAnomaly ? '#ff4b4b' : '#00ff00'}">${isAnomaly ? 'CRITICAL' : 'OK'}</td>
                    <td>${score.toFixed(4)}</td>
                    <td>${(sensors['sensor_00']||0).toFixed(2)}</td>
                    <td>${(sensors['sensor_01']||0).toFixed(2)}</td>
                    <td>${(sensors['sensor_02']||0).toFixed(2)}</td>
                `;
                tbody.insertBefore(row, tbody.firstChild);
                if(tbody.children.length > 20) tbody.removeChild(tbody.lastChild);

            } catch (error) {
                console.error(error);
                document.getElementById('apiStatus').innerHTML = `<span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span> Error`;
            }
        }

        async function startSimulation() {
            if (isRunning) return;
            isRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').classList.add("opacity-50");

            // Scenario: 15 Normal -> 5 Broken -> 15 Normal
            const scenario = [
                ...Array(15).fill(false), // Normal
                ...Array(5).fill(true),   // Broken
                ...Array(15).fill(false)  // Normal
            ];

            let i = 0;
            setInterval(async () => {
                // Loop the scenario
                if (i >= scenario.length) i = 0; 
                await updateDashboard(scenario[i]);
                i++;
            }, 800); // 800ms refresh
        }

        initCharts();
    </script>
</body>
</html>